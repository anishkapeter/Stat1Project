---
title: "HousePrice Prediction"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: yes
date: "2023-07-30"
---

# Load necessary packages, load data.

```{R,warning=FALSE, message=FALSE}
#load necessary packages:
library(car)
library(tidyverse)
library(caret)
library(multiUS)
library(boot)
library(ggplot2)
library(ggpubr)

#Load Data

data=read.csv('https://raw.githubusercontent.com/anishkapeter/Stat1Project/main/train.csv')

```
# Fill missing values in numeric columns with KNN imputation
```{r,warning=FALSE, message=FALSE}
numeric_cols <- names(data)[sapply(data, is.numeric)]
#colSums(is.na(data[,numeric_cols]))
#mode(data$LotFrontage)


categorical_cols <- names(data)[sapply(data, is.character)]
#length(categorical_cols)+length(numeric_cols)
numeric_data <- data[, numeric_cols]
numeric_data_imputed <- KNNimp(as.matrix(numeric_data))  # convert data frame to matrix for knnImpute
data[numeric_cols] <- numeric_data_imputed

```

# Define ordinal columns and apply factor encoding
```{r,warning=FALSE, message=FALSE}
ordinal_cols <- c('ExterQual', 'ExterCond', 'BsmtQual', 'BsmtCond', 
                  'GarageCond', 'GarageQual', 'PoolQC', 'FireplaceQu', 
                  'HeatingQC', 'KitchenQual', 'BsmtExposure', 'BsmtFinType1', 
                  'BsmtFinType2', 'CentralAir', 'Fence','GarageFinish','Alley','LotShape','LandSlope')



data[ordinal_cols] <- lapply(data[ordinal_cols], function(x) as.numeric(as.factor(x)))

data[ordinal_cols] <- lapply(data[ordinal_cols], function(x) replace(x, is.na(x), 0))





# Transform ordinal columns into factors and replace NA with 0

#data[ordinal_cols] <- lapply(data[ordinal_cols], function(x) {
#  x <- as.factor(x)
#  levels(x) <- c(levels(x), "0")
# x[is.na(x)] <- "0"
#  return(x)
# })

# Convert all character columns to factors and add NA as a level
colnames(data)[sapply(data, is.character)]



# Threshold for 'rare' observations
n <- 10 

# Loop through the character columns
for (col_name in colnames(data)[sapply(data, is.character)]) {
  # Convert rare observations to 'Other'
  data[[col_name]] <- ifelse(data[[col_name]] %in% names(which(table(data[[col_name]]) < n)), "Other", data[[col_name]])
  
  # Convert column to factor
  data[[col_name]] <- as.factor(data[[col_name]])

  # Add NA as a level if there are any NAs in the column
  if(any(is.na(data[[col_name]]))) {
    data[[col_name]] <- addNA(data[[col_name]])
    
  
  }
}

#Deleting some columns
rare_level_factors <- sapply(data2, function(x) is.factor(x) && any(table(x) <= 2))
print(names(data2)[rare_level_factors])


data$Electrical=as.character(data$Electrical)
data$Electrical[is.na(data$Electrical)] <- "Other"
data$Electrical=as.factor(data$Electrical)
table(data$Electrical)

data <- data[,-which(names(data) == "Utilities")]


# No more missing values, ordinary variable has been factorized

sum(is.na(data))
#class(data$MiscFeature)
#table(data$Utilities)




```


# Checking assumption for regression (full model)

```{r,warning=FALSE, message=FALSE}
model = lm(SalePrice ~., data = data)


# residual plots / Histogram / Q-Q plot / Calculate Cook's distances /Create Residuals vs Leverage plot
histogram(model$residuals)
plot(model)



#Look for influential observations

#Looking at observation 1171,1424, delete them in the data
data= data[-c(1171,1424),]
```




# Loggin SalePrice to see if it fix the clusterred residuals
```{r,warning=FALSE, message=FALSE}
data2=data
data2$SalePrice = log(data$SalePrice)
model2 = glm(SalePrice~., data = data2)
residualPlot(model2)


# Compare to model1(unlogged) , the residual plots forms a rather perfect random cloud formation which is ideal
# Histogram
res2= model2$residuals
histogram(res2)

plot(model2)
```



# Perform a forward/backward/stepwise selection based on AIC 

```{r,results='hide',warning=FALSE, message=FALSE}
null_model <- glm(SalePrice ~ 1, data = data2)
forward_model <- step(null_model, 
                      scope = list(lower = null_model, upper = model2), 
                      direction = "forward")

# Perform backward selection based on AIC
backward_model <- step(model2, 
                       direction = "backward")


# Perform stepwise selection
stepwise_model <- step(model2, direction = "both")
```



# Calculating CV Press 
```{r,warning=FALSE, message=FALSE}







cv_errors <- numeric(nrow(data2))

for(i in 1:nrow(data2)) {
  model_loocv <- glm(formula(forward_model), 
    data = data2[-i, ])
  predicted <- predict(model_loocv, newdata = data2[i, ])
  cv_errors[i] <- sum((predicted - data2$SalePrice[i])^2)
}
cv_error <- mean(cv_errors, na.rm = TRUE)





# Forward CV Press
forward <- glm(formula(forward_model), data = data2)


cv.error_foward <- cv.glm(data2, forward, K = 10)

cv.error_foward$delta



# Backward CV Press
Backward <- glm(formula(backward_model), data = data2)


cv.error_Backward <- cv.glm(data2, Backward, K = 10)

cv.error_Backward$delta


# Stepwise CV Press
Stepwise <- glm(formula(stepwise_model), data = data2)


cv.error_Stepwise<- cv.glm(data2, Stepwise, K = 10)

cv.error_Stepwise$delta



```



# Build custom regression model





# Examin relationship in Sales price in neighborhood 'NAmes', 'Edwards', 'BrkSide' 
```{r,warning=FALSE, message=FALSE}
options(scipen = 999)

filtered_neighborhood = data %>% filter (Neighborhood %in% c('NAmes', 'Edwards', 'BrkSide'))

filtered_neighborhood_model= glm(SalePrice ~ GrLivArea, data = filtered_neighborhood)
summary(filtered_neighborhood_model)

residualPlot(filtered_neighborhood_model)
histogram(filtered_neighborhood_model$residuals)



# Residual plot clustered, using log-log method to transform the dataset

data3=data
data3$SalePrice = log(data$SalePrice)
data3$GrLivArea = log(data$GrLivArea)

filtered_data2 <- data3 %>% filter(Neighborhood %in% c('NAmes', 'Edwards', 'BrkSide'))

filtered_data2_model = glm(SalePrice ~ GrLivArea, data = filtered_data2)

histogram(filtered_data2_model$residuals)
plot(filtered_data2_model)


#Observation 337 seems to be very influential, sales price is low for a huge area house, choosing to delete


filtered_data2 <- filtered_data2 [ -c(337),]

filtered_data2_model = glm(SalePrice ~ GrLivArea, data = filtered_data2)

histogram(filtered_data2_model$residuals)
plot(filtered_data2_model)
summary(filtered_data2_model)

plot(filtered_data2$GrLivArea, filtered_data2$SalePrice, 
     main="Scatterplot with Regression Line", 
     xlab="Above grade (ground) living area square feet (GrLivArea)", 
     ylab="Sale Price (SalePrice)", pch=19, frame=FALSE, col="blue")

# Add the regression line
abline(filtered_data2_model, col="red")
```
#### Therefore the regression model predicting SalePrice using GrlivArea is 
SalePrice = 7.58437 + 0.59230 * GrlivArea


# Adding interation variables
```{r, warning=FALSE, message=FALSE}

# Fit the model
filtered_data2_model2 <- glm(SalePrice ~  GrLivArea + GrLivArea * Neighborhood, data = filtered_data2)

# Summary of the model
model_summary <- summary(filtered_data2_model2)
model_summary

# Confidence intervals
model_confint <- confint(filtered_data2_model2)
model_confint

# Residuals histogram
histogram <- ggplot(filtered_data2_model2, aes(x=residuals)) +
  geom_histogram(binwidth=1, color="black", fill="white") +
  theme_minimal() +
  labs(x="Residuals", y="Frequency", title="Histogram of Residuals")

# Model diagnostics
plot_diag <- plot(filtered_data2_model2, diagnostic = TRUE)


# Model Coefficients
model_coef <- coef(filtered_data2_model2)

```


# Model Summaries

#### For each neighborhood, the regression model predicting SalePrice using GrLivArea is given by:

#### Neighborhood 'BrkSide':

logSalePrice =  5.91292 + 0.81965*logGrLivArea

##### Interpretation of the Coefficients 
For every doubling in the grlivarea, there is an estimated multiplicative increase of 1.76497775436 in the median Sale Price. 
When the GrLivingArea is 0, the estimated median SalePrice 369.78435.

##### Interpretation of Confidence Intervals   
When the GrLivArea is 0 sq.ft., the estimated median Sale Price is between 137.791310802 and 992.375099193 in Brookside neighborhood.
For every doubling of square footage, the estimated multiplicative increase in median Sales Price for Brookeside is between 1.60159991198 and 1.94501637332. 


#### Neighborhood 'NAmes':
logSalePrice = 7.74784 + 0.47303*logGrLivArea


##### Interpretation of the Coefficients 
For every doubling in the GrLivArea, there is an estimated multiplicative increase of 1.38802158181 in the median Sale Price. 
When the GrLivingArea is 0, the estimated median SalePrice 2316.56323.

##### Interpretation of Confidence Intervals   
When the GrLivArea is 0 sq.ft., the estimated median Sale Price is between 137.791310802 and 992.375099193 in North Ames neighborhood.
For every doubling of square footage, the estimated multiplicative increase in median Sales Price for North Ames is between 1.12268041109 and 1.7160598979. 


#### Neighborhood 'Edwards':
logSalePrice = 8.49273 + 0.55639 *logGrLivArea

##### Interpretation of the Coefficients 
For every doubling in the grlivarea, there is an estimated multiplicative increase of 1.47058482203 in the median Sale Price. 
When the GrLivingArea is 0, the estimated median SalePrice 4879.16804.

##### Confidence Intervals and Interpretation 

When the GrLivArea is 0 sq.ft., the estimated median Sale Price is between 233.902158067 and 22943.202173 for houses in the Edwards Neighborhood.
For every doubling of square footage, the estimated multiplicative increase in median Sales Price for Edwards Neighborhood is between 1.1742930628 and 1.84164270122.






filtered_data2
library(ggplot2)
filtered_neighborhood %>% 
  filter(Neighborhood == "BrkSide") %>% 
  ggplot(aes(x=GrLivArea, y = SalePrice)) + 
  geom_point( color = "steelblue") + 
  ggtitle("Sale Price vs Living Area Sq.Ft in Brookside") +
  xlab("Square Footage of Living Area") +
  ylab("Sales Price in Dollars")


filtered_neighborhood %>% 
  filter(Neighborhood == "Edwards") %>% 
  ggplot(aes(x=GrLivArea, y = SalePrice)) + 
  geom_point( color = "steelblue") + 
  ggtitle("Sale Price vs Living Area Sq.Ft in Edwards") +
  xlab("Square Footage of Living Area") +
  ylab("Sales Price in Dollars")

filtered_neighborhood %>% 
  filter(Neighborhood == "NAmes") %>% 
  ggplot(aes(x=GrLivArea, y = SalePrice)) + 
  geom_point(color = "steelblue") + 
  ggtitle("Sale Price vs Living Area Sq.Ft in North Ames") +
  xlab("Square Footage of Living Area") +
  ylab("Sales Price in Dollars")






